[
{% set ethernet_interfaces_names_list = [] %}
{% for interface in ethernet_interfaces %}
    {%- if ethernet_interfaces_names_list.append(interface['name']) %}{% endif %}
{% endfor %}
{% set ethernet_interfaces_names = ethernet_interfaces_names_list | join(',') %}
    {
        "BUFFER_POOL_TABLE:ingress_lossless_pool": {
            "size": "3024486",
            "type": "ingress",
            "mode": "dynamic"
        },
        "OP": "SET"
    },
    {
        "BUFFER_POOL_TABLE:ingress_lossy_pool": {
            "size": "6422528",
            "type": "ingress",
            "mode": "dynamic"
        },
        "OP": "SET"
    },
    {
        "BUFFER_POOL_TABLE:egress_lossless_pool": {
            "size": "7291456",
            "type": "egress",
            "mode": "dynamic"
        },
        "OP": "SET"
    },
    {
        "BUFFER_POOL_TABLE:egress_lossy_pool": {
            "size": "8254464",
            "type": "egress",
            "mode": "dynamic"
        },
        "OP": "SET"
    },
    {
        "BUFFER_PROFILE_TABLE:ingress_lossless_profile": {
            "pool":"[BUFFER_POOL_TABLE:ingress_lossless_pool]",
            "size":"0",
            "dynamic_th":"7"
        },
        "OP": "SET"
    },
    {
        "BUFFER_PROFILE_TABLE:ingress_lossy_profile": {
            "pool":"[BUFFER_POOL_TABLE:ingress_lossy_pool]",
            "size":"0",
            "dynamic_th":"7"
        },
        "OP": "SET"
    },
    {
        "BUFFER_PROFILE_TABLE:egress_lossless_profile": {
            "pool":"[BUFFER_POOL_TABLE:egress_lossless_pool]",
            "size":"1518",
            "dynamic_th":"7"
        },
        "OP": "SET"
    },
    {
        "BUFFER_PROFILE_TABLE:egress_lossy_profile": {
            "pool":"[BUFFER_POOL_TABLE:egress_lossy_pool]",
            "size":"4096",
            "dynamic_th":"7"
        },
        "OP": "SET"
    },
    {
        "BUFFER_PROFILE_TABLE:pg_lossless_profile": {
            "pool":"[BUFFER_POOL_TABLE:ingress_lossless_pool]",
            "xon":"35616",
            "xoff":"31814",
            "size":"67430",
            "dynamic_th":"1"
        },
        "OP": "SET"
    },
    {
        "BUFFER_PROFILE_TABLE:pg_lossy_profile": {
            "pool":"[BUFFER_POOL_TABLE:ingress_lossy_pool]",
            "size":"0",
            "dynamic_th":"3"
        },
        "OP": "SET"
    },
    {
        "BUFFER_PROFILE_TABLE:q_lossless_profile": {
            "pool":"[BUFFER_POOL_TABLE:egress_lossless_pool]",
            "size":"0",
            "dynamic_th":"7"
        },
        "OP": "SET"
    },
    {
        "BUFFER_PROFILE_TABLE:q_lossy_profile": {
            "pool":"[BUFFER_POOL_TABLE:egress_lossy_pool]",
            "size":"0",
            "dynamic_th":"1"
        },
        "OP": "SET"
    },
    {
        "BUFFER_PORT_INGRESS_PROFILE_LIST:{{ ethernet_interfaces_names }}": {
            "profile_list" : "[BUFFER_PROFILE_TABLE:ingress_lossless_profile],[BUFFER_PROFILE_TABLE:ingress_lossy_profile]"
        },
        "OP": "SET"
    },
    {
        "BUFFER_PORT_EGRESS_PROFILE_LIST:{{ ethernet_interfaces_names }}": {
            "profile_list" : "[BUFFER_PROFILE_TABLE:egress_lossless_profile],[BUFFER_PROFILE_TABLE:egress_lossy_profile]"
        },
        "OP": "SET"
    },
    {
        "BUFFER_PROFILE_TABLE:pg_lossless_10G_5m_profile": {
            "pool":"[BUFFER_POOL_TABLE:ingress_lossless_pg_pool]",
            "xon":"18432",
            "xoff":"16384",
            "size":"34816",
            "dynamic_th":"1"
        },
        "OP": "SET"
    },
    {
        "BUFFER_PROFILE_TABLE:pg_lossless_25G_5m_profile": {
            "pool":"[BUFFER_POOL_TABLE:ingress_lossless_pg_pool]",
            "xon":"18432",
            "xoff":"16384",
            "size":"34816",
            "dynamic_th":"1"
        },
        "OP": "SET"
    },
    {
        "BUFFER_PROFILE_TABLE:pg_lossless_40G_5m_profile": {
            "pool":"[BUFFER_POOL_TABLE:ingress_lossless_pg_pool]",
            "xon":"18432",
            "xoff":"16384",
            "size":"34816",
            "dynamic_th":"1"
        },
        "OP": "SET"
    },
    {
        "BUFFER_PROFILE_TABLE:pg_lossless_50G_5m_profile": {
            "pool":"[BUFFER_POOL_TABLE:ingress_lossless_pg_pool]",
            "xon":"18432",
            "xoff":"16384",
            "size":"34816",
            "dynamic_th":"1"
        },
        "OP": "SET"
    },
    {
        "BUFFER_PROFILE_TABLE:pg_lossless_100G_5m_profile": {
            "pool":"[BUFFER_POOL_TABLE:ingress_lossless_pg_pool]",
            "xon":"18432",
            "xoff":"18432",
            "size":"36864",
            "dynamic_th":"1"
        },
        "OP": "SET"
    },
    {
        "BUFFER_PROFILE_TABLE:pg_lossless_10G_40m_profile": {
            "pool":"[BUFFER_POOL_TABLE:ingress_lossless_pg_pool]",
            "xon":"18432",
            "xoff":"18432",
            "size":"36864",
            "dynamic_th":"1"
        },
        "OP": "SET"
    },
    {
        "BUFFER_PROFILE_TABLE:pg_lossless_25G_40m_profile": {
            "pool":"[BUFFER_POOL_TABLE:ingress_lossless_pg_pool]",
            "xon":"18432",
            "xoff":"21504",
            "size":"39936",
            "dynamic_th":"1"
        },
        "OP": "SET"
    },
    {
        "BUFFER_PROFILE_TABLE:pg_lossless_40G_40m_profile": {
            "pool":"[BUFFER_POOL_TABLE:ingress_lossless_pg_pool]",
            "xon":"18432",
            "xoff":"23552",
            "size":"41984",
            "dynamic_th":"1"
        },
        "OP": "SET"
    },
    {
        "BUFFER_PROFILE_TABLE:pg_lossless_50G_40m_profile": {
            "pool":"[BUFFER_POOL_TABLE:ingress_lossless_pg_pool]",
            "xon":"18432",
            "xoff":"23552",
            "size":"41984",
            "dynamic_th":"1"
        },
        "OP": "SET"
    },
    {
        "BUFFER_PROFILE_TABLE:pg_lossless_100G_40m_profile": {
            "pool":"[BUFFER_POOL_TABLE:ingress_lossless_pg_pool]",
            "xon":"18432",
            "xoff":"35840",
            "size":"54272",
            "dynamic_th":"1"
        },
        "OP": "SET"
    },
    {
        "BUFFER_PROFILE_TABLE:pg_lossless_10G_300m_profile": {
            "pool":"[BUFFER_POOL_TABLE:ingress_lossless_pg_pool]",
            "xon":"18432",
            "xoff":"30720",
            "size":"49152",
            "dynamic_th":"1"
        },
        "OP": "SET"
    },
    {
        "BUFFER_PROFILE_TABLE:pg_lossless_25G_300m_profile": {
            "pool":"[BUFFER_POOL_TABLE:ingress_lossless_pg_pool]",
            "xon":"18432",
            "xoff":"53248",
            "size":"71680",
            "dynamic_th":"1"
        },
        "OP": "SET"
    },
    {
        "BUFFER_PROFILE_TABLE:pg_lossless_40G_300m_profile": {
            "pool":"[BUFFER_POOL_TABLE:ingress_lossless_pg_pool]",
            "xon":"18432",
            "xoff":"75776",
            "size":"94208",
            "dynamic_th":"1"
        },
        "OP": "SET"
    },
    {
        "BUFFER_PROFILE_TABLE:pg_lossless_50G_300m_profile": {
            "pool":"[BUFFER_POOL_TABLE:ingress_lossless_pg_pool]",
            "xon":"18432",
            "xoff":"75776",
            "size":"94208",
            "dynamic_th":"1"
        },
        "OP": "SET"
    },
    {
        "BUFFER_PROFILE_TABLE:pg_lossless_100G_300m_profile": {
            "pool":"[BUFFER_POOL_TABLE:ingress_lossless_pg_pool]",
            "xon":"18432",
            "xoff":"165888",
            "size":"184320",
            "dynamic_th":"1"
        },
        "OP": "SET"
    },

{# The following template part is for variable PG profile configuration #}
{% set pg_range = '3-4' %}
{% set supported_speed = [10000, 25000, 40000, 50000, 100000] %}
{% set supported_cable = [5, 40, 300] %}

{# The key in this lictionary consist of two parts: (port speed)_(cable length) #}
{%- set portconfig2profile = {
        '10000_5'   : { 'name' : 'BUFFER_PROFILE_TABLE:pg_lossless_10G_5m_profile',  'size' : 34816 },
        '25000_5'   : { 'name' : 'BUFFER_PROFILE_TABLE:pg_lossless_25G_5m_profile',  'size' : 34816 },
        '40000_5'   : { 'name' : 'BUFFER_PROFILE_TABLE:pg_lossless_40G_5m_profile',  'size' : 34816 },
        '50000_5'   : { 'name' : 'BUFFER_PROFILE_TABLE:pg_lossless_50G_5m_profile',  'size' : 34816 },
        '100000_5'  : { 'name' : 'BUFFER_PROFILE_TABLE:pg_lossless_100G_5m_profile', 'size' : 36864 },

        '10000_40'  : { 'name' : 'BUFFER_PROFILE_TABLE:pg_lossless_10G_40m_profile',  'size' : 36864 },
        '25000_40'  : { 'name' : 'BUFFER_PROFILE_TABLE:pg_lossless_25G_40m_profile',  'size' : 39936 },
        '40000_40'  : { 'name' : 'BUFFER_PROFILE_TABLE:pg_lossless_40G_40m_profile',  'size' : 41984 },
        '50000_40'  : { 'name' : 'BUFFER_PROFILE_TABLE:pg_lossless_50G_40m_profile',  'size' : 44444 },
        '100000_40' : { 'name' : 'BUFFER_PROFILE_TABLE:pg_lossless_100G_40m_profile', 'size' : 54272 },

        '10000_300' : { 'name' : 'BUFFER_PROFILE_TABLE:pg_lossless_10G_300m_profile',  'size' : 49152 },
        '25000_300' : { 'name' : 'BUFFER_PROFILE_TABLE:pg_lossless_25G_300m_profile',  'size' : 71680 },
        '40000_300' : { 'name' : 'BUFFER_PROFILE_TABLE:pg_lossless_40G_300m_profile',  'size' : 94208 },
        '50000_300' : { 'name' : 'BUFFER_PROFILE_TABLE:pg_lossless_50G_300m_profile',  'size' : 55555 },
        '100000_300': { 'name' : 'BUFFER_PROFILE_TABLE:pg_lossless_100G_300m_profile', 'size' : 184320 }
        }
-%}

{% set ports2cable = {
        'ToRRouter_Server'       : '5',
        'LeafRouter_ToRRouter'   : '40',
        'SpineRouter_LeafRouter' : '300'
        }
%}

{% set switch_role = minigraph_devices[minigraph_hostname]['type'] %}

{%- macro cable_length(interface_name) -%}
    {% set nei = '"'+minigraph_neighbors[interface_name]['name']+'"' -%}
    {% set nei_role = minigraph_devices[nei]['type'] -%}
    {% set roles1 = switch_role + '_' + nei_role %}
    {%- set roles2 = nei_role + '_' + switch_role -%}
    {%- if roles1 in ports2cable -%}
        {{ ports2cable[roles1] }}
    {%- elif roles2 in ports2cable -%}
        {{ ports2cable[roles2] }}
    {%- else -%}
        {{ supported_cable | last }}
    {%- endif -%}
{% endmacro %}

{%- macro find_closest_greater_config(speed, cable) -%}
{%- set new_speed = [] -%}
{%- for std_speed in supported_speed -%}
    {%- if std_speed | int >= speed | int -%}
        {%- if new_speed.append(std_speed) -%}{%- endif -%}
    {% endif -%}
{%- endfor -%}
{%- set new_cable = [] -%}
{%- for std_cable in supported_cable -%}
    {% if std_cable | int >= cable | int -%}
        {%- if new_cable.append(std_cable) -%}{%- endif -%}
    {% endif %}
{%- endfor -%}
{{ new_speed.0 }}_{{ new_cable.0 }}
{%- endmacro -%}

{% set ingress_lossless_pg_pool_size =  [] %}
{% for interface in ethernet_interfaces %}
    {%- set speed = interface['speed'] -%}
    {%- set cable = cable_length(interface['name']) -%}
    {%- set port_config = speed + '_' + cable -%}
    {%- if not port_config in portconfig2profile -%}
        {% set port_config = find_closest_greater_config(speed, cable) -%}
    {%- endif -%}
    {% set profile = portconfig2profile[port_config] -%}
    {% if ingress_lossless_pg_pool_size.append(profile['size']) %}{% endif %}
    {
        "BUFFER_PG_TABLE:{{ interface['name'] }}:{{ pg_range }}": {
                "profile" : "[{{ profile['name'] }}]"
        },
        "OP": "SET"
    },

{% endfor -%}

    {# Look-up tables for run-time buffer profile update #}
    {# port config to profile lookup table -#}
    {
        "BUFFER_PORT_CONFIG_TO_PG_PROFILE_TABLE:AZURE": {
        {% for key, value in portconfig2profile.items() %}
        "{{ key }}" : "[{{ value['name'] }}]"{% if not loop.last %},{% endif %}

        {% endfor %}

        },
        "OP": "SET"
    },

    {# port name to cable length lookup table -#}
    {
        "BUFFER_PORT_CABLE_LENGTH_TABLE:AZURE": {
        {% for interface in ethernet_interfaces %}
        {%- set cable = cable_length(interface['name']) %}
        "{{ interface['name'] }}" : "{{ cable }}"{%- if not loop.last -%},{%- endif %}

        {% endfor -%}
        },
        "OP": "SET"
    },

    {# Pool declaration -#}
    {
        "BUFFER_POOL_TABLE:ingress_lossless_pg_pool": {
            "size": "{{ ingress_lossless_pg_pool_size | sum }}",
            "type": "ingress",
            "mode": "dynamic"
        },
        "OP": "SET"
    },

    {
        "BUFFER_PG_TABLE:{{ ethernet_interfaces_names }}:0-1": {
            "profile" : "[BUFFER_PROFILE_TABLE:pg_lossy_profile]"
        },
        "OP": "SET"
    },
    {
        "BUFFER_QUEUE_TABLE:{{ ethernet_interfaces_names }}:3-4": {
            "profile" : "[BUFFER_PROFILE_TABLE:q_lossless_profile]"
        },
        "OP": "SET"
    },
    {
        "BUFFER_QUEUE_TABLE:{{ ethernet_interfaces_names }}:0-1": {
            "profile" : "[BUFFER_PROFILE_TABLE:q_lossy_profile]"
        },
        "OP": "SET"
    },
    {
        "PFC_PRIORITY_TO_PRIORITY_GROUP_MAP_TABLE:AZURE": {
            "0": "0",
            "1": "1",
            "3": "3",
            "4": "4"
        },
        "OP": "SET"
    },
    {
        "PORT_QOS_MAP_TABLE:{{ ethernet_interfaces_names }}": {
            "pfc_to_pg_map"   : "[PFC_PRIORITY_TO_PRIORITY_GROUP_MAP_TABLE:AZURE]"
        },
        "OP": "SET"
    }
]


